#!/usr/bin/env zsh
#compdef nbcli

_nbcli() {
  local -a commands
  commands=(
    "status:Fetch /api/status/"
    "get:GET an API path"
    "list:List an endpoint"
    "dump:Dump all API objects to a file"
  )

  _arguments -s \
    "(-h --help)"{-h,--help}"[show help]" \
    "--timeout[HTTP timeout in seconds]:seconds: " \
    "--insecure[disable TLS verification]" \
    "--plain[plain output]" \
    "--json[JSON output]" \
    "--yaml[YAML output]" \
    "--csv[CSV output]" \
    "1:command:->cmds" \
    "*::arg:->args"

  case $state in
    cmds)
      _describe "command" commands
      return
      ;;
    args)
      case $words[1] in
        get)
          _arguments \
            "1:path (API path or URL): " \
            "--param[query param key=value]:param: " \
            "--filter[filter key=value]:filter: " \
            "--path[select dotted path]:path: "
          ;;
        list)
          _arguments \
            "1:endpoint (e.g. dcim/devices): " \
            "--param[query param key=value]:param: " \
            "--filter[filter key=value]:filter: " \
            "--path[select dotted path]:path: " \
            "--all[follow pagination]"
          ;;
        dump)
          _arguments \
            "1:filename:_files" \
            "--include-all[include jobs and object changes]"
          ;;
      esac
      ;;
  esac
}

_nbcli "$@"
